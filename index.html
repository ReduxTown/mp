<script>
const input = document.getElementById('username');
const btn = document.getElementById('checkBtn');
const result = document.getElementById('result');

const validPattern = /^[a-zA-Z0-9_]+$/;

async function checkAvailability(name) {
  result.className = 'checking';
  result.innerHTML = 'Checking availability...';

  try {
    // Use profile endpoint – if username available → usually 404 or no redirect to real profile
    const profileUrl = `https://www.roblox.com/users/profile?username=${encodeURIComponent(name)}`;

    const res = await fetch(profileUrl, {
      method: 'HEAD',  // HEAD is lighter, avoids downloading full page
      redirect: 'manual',  // Don't follow redirects
      credentials: 'omit',
      headers: {
        'Accept': 'text/html',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) EthereonUs/1.0'
      }
    });

    // If available: often 404, or redirects to login/signup if not logged in
    // If taken: 200 + redirects to actual profile (or serves profile content)
    if (res.status === 404 || res.type === 'opaqueredirect' || res.url.includes('notfound')) {
      result.className = 'available';
      result.innerHTML = `✅ <strong>${name}</strong> appears available!<br>Go claim it on Roblox! ✨`;
    } else if (res.status === 200 || res.redirected) {
      result.className = 'taken';
      result.innerHTML = `❌ <strong>${name}</strong> is taken.`;
    } else {
      result.className = 'invalid';
      result.innerHTML = `⚠️ Unexpected status: ${res.status}<br>Try again or check manually.`;
    }

  } catch (err) {
    result.className = 'invalid';
    result.innerHTML = `Error: ${err.message}<br><small>(CORS, network, or Roblox blocked direct check)</small>`;
    console.error(err);
  }
}

function handleCheck() {
  const name = input.value.trim();

  if (!name) {
    result.className = 'invalid';
    result.textContent = 'Please enter a username.';
    return;
  }

  if (name.length < 3 || name.length > 20) {
    result.className = 'invalid';
    result.textContent = 'Username must be 3–20 characters.';
    return;
  }

  if (!validPattern.test(name)) {
    result.className = 'invalid';
    result.textContent = 'Only letters, numbers, and underscore (_) allowed.';
    return;
  }

  checkAvailability(name);
}

btn.addEventListener('click', handleCheck);

input.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    handleCheck();
  }
});
</script>
